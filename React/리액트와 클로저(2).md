## ë¦¬ì•¡íŠ¸ì™€ í´ë¡œì €(2)



### useEffect  êµ¬í˜„í•˜ê¸°

[ì´ì „ì— useStateë¥¼ êµ¬í˜„í•´ë³´ì•˜ìŠµë‹ˆë‹¤.]()

ì´ë²ˆì—ëŠ” useEffectë¥¼ ì¶”ê°€í•´ ë³´ê² ìŠµë‹ˆë‹¤.



ê¸°ì¡´ì— useStateë¥¼ êµ¬í˜„í–ˆë˜ MyReactì— useEffect ë©”ì†Œë“œë¥¼ ì¶”ê°€í•˜ê³ ,

Counter í•¨ìˆ˜ì—ëŠ” useEffectë¥¼ ì‹¤í—˜í•˜ê¸° ìœ„í•œ noopì´ë¼ëŠ” ë©”ì†Œë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

```javascript
const MyReact = (function () {
  let _val, _deps; // _depsëŠ” ì˜ì¡´ì„± ë°°ì—´ì„ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.

  return {
    render(Component) {
      const C = new Component();
      C.render();
      return C;
    },
    useState(initVal) {
      _val = _val || initVal;
      function setState(newVal) {
        _val = newVal;
      }
      return [_val, setState];
    },
    useEffect(callback, depArray) {
      const oldDeps = deps;
      let hasChanged = true;
      if (oldDeps) {
      	hasChanged = depArray.some((dep, i) => !Object.is(dep, _deps[i]));
      }
      if (hasChanged) cb();
      _deps = depArray;
    },
  };
})();

function Counter() {
  const [count, setCount] = MyReact.useState(0);
  MyReact.useEffect(() => {
    console.log('effect: ', count);
  }, [count]);

  return {
    render() {
      console.log('render: ', count);
    },
    click() {
      setCount(count + 1);
    },
    noop() {
      setCount(count);
    },
  };
}

let App;
App = MyReact.render(Counter); // effect: 0 render:  0

App.click();
// ìƒˆë¡œìš´ count ê°’ì„ ë°›ê¸° ìœ„í•´ ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•©ë‹ˆë‹¤.
App = MyReact.render(Counter); // effect: 1 render: 1 

App.noop();
App = MyReact.render(Counter); // render: 1
```

* useEffectëŠ” callback í•¨ìˆ˜ì™€, depArrayë¼ëŠ” ì˜ì¡´ì„± ë°°ì—´ì„ ë§¤ê°œë³€ìˆ˜ë¡œ ê°–ê³  ìˆìŠµë‹ˆë‹¤.

  Counter ì»´í¬ë„ŒíŠ¸ë¥¼ ìƒˆë¡œ ë Œë”ë§í•  ë•Œë§ˆë‹¤ useEffectê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

* useEffectëŠ” ë‚´ë¶€ì—ì„œ ì „ë‹¬ëœ ì˜ì¡´ì„± ë°°ì—´ì´ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

  ë§Œì•½ ì—†ë‹¤ë©´, callbackí•¨ìˆ˜ê°€ ë¬´ì¡°ê±´ í˜¸ì¶œë©ë‹ˆë‹¤.

* ì „ë‹¬ëœ ì˜ì¡´ì„± ë°°ì—´ì´ ìˆë‹¤ë©´ ê¸°ì¡´ì— ê°–ê³  ìˆë˜ ì˜ì¡´ì„± ë°°ì—´(_deps)ì™€ ë¹„êµí•©ë‹ˆë‹¤.

  ì˜ì¡´ì„± ë°°ì—´ì˜ ê°’ì— ë³€í™”ê°€ ìˆë‹¤ë©´ callbackí•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

* ë§ˆì§€ë§‰ìœ¼ë¡œ, _depsì— ë³€í™”ëœ ì˜ì¡´ì„± ë°°ì—´ì„ ë°˜ì˜í•©ë‹ˆë‹¤.



### ì‹±ê¸€í†¤ ëª¨ë“ˆì„ ê°œì„ í•˜ê¸°

MyReact ëª¨ë“ˆì€ í•œê°€ì§€ ì¹˜ëª…ì ì¸ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì‹±ê¸€í†¤ í˜•íƒœì´ê¸° ë•Œë¬¸ì—, ì—¬ëŸ¬ê°€ì§€ í›…ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

useStateëŠ” _valì„, ê·¸ë¦¬ê³  useEffectëŠ” depsë¼ëŠ” ê°ê° í•˜ë‚˜ì˜ ë³€ìˆ˜ë§Œì„ ì°¸ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ ë˜ë©´ ì—¬ëŸ¬ê°œì˜ useStateë‚˜ useEffectë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.



ì´ë¥¼ ê°œì„ í•œ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

í›…ì´ ì°¸ì¡°í•˜ëŠ” ê°’ë“¤ì„ ë°°ì—´ì— ë‹´ê² ìŠµë‹ˆë‹¤.

```javascript
const MyReact = (function () {
  let hooks = [];		// hookì´ ì°¸ì¡°í•˜ëŠ” ê°’ë“¤ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
  let idx = 0;	// ìœ„ ë°°ì—´ì„ ìˆœíšŒí•˜ê¸° ìœ„í•œ ì¸ë±ìŠ¤

  return {
    render(Component) {
      const C = Component();
      C.render();
      idx = 0; // ë‹¤ìŒ ë Œë”ë§ì„ ìœ„í•œ ë¦¬ì…‹, ì´ ë¶€ë¶„ì„ ì˜ ê¸°ì–µí•´ì•¼ í•©ë‹ˆë‹¤!
      return C;
    },
    useState(initVal) {
      hooks[idx] = hooks[idx] || initVal;
      const _idx = idx;
      // ì•½ê°„ ì˜ë¬¸ì´ ë“œëŠ” ì½”ë“œ
      // ì•„ë˜ì— ì„¤ëª…ì´ ì´ì–´ì§‘ë‹ˆë‹¤!
      function setState(newValue) {
        hooks[_idx] = newValue;
      }
      return [hooks[idx++], setState];
    },
    useEffect(callback, depArray) {
      const oldDeps = hooks[idx];
      let hasChanged = true;
      if (oldDeps) {
      	hasChanged = depArray.some((dep, i) => !Object.is(dep, oldDeps[i]));
      }
      if (hasChanged) cb();
      hooks[idx] = depArray;
      idx++;
    },
  };
})();

function Counter() {
  const [count, setCount] = MyReact.useState(0);
  const [message, setMessage] = MyReact.useState('hi');
  MyReact.useEffect(() => {
    console.log('effect: ', count, message);
  }, [count, message]);

  return {
    render() {
      console.log('render: ', count, message);
    },
    newMessage(text) {
      setMessage(text);
    },
    click() {
      setCount(count + 1);
    },
    noop() {
      setCount(count);
    },
  };
}

let App;
App = MyReact.render(Counter);
// effect: 0 hi
// render: 0 hi
App.click();
App = MyReact.render(Counter);
// effect: 1 hi
// render: 1 hi
App.newMessage('bye');
App = MyReact.render(Counter);
// effect: 1 bye
// render: 1 bye

```



* ì‘ì„±í•˜ë‹¤ë³´ë©´ useStateì—ì„œ ì´ìƒí•˜ë‹¤ê³  ëŠë‚€ ë¶€ë¶„ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ```javascript
  useState(initVal) {
        hooks[idx] = hooks[idx] || initVal;
        const _idx = idx;
        function setState(newVal) {
          hooks[_idx] = newVal;
        }
        return [hooks[idx++], setState];
  }
  ```

  êµ³ì´ setStateHookIndexì— currentHookì„ í• ë‹¹í•˜ì—¬ ìƒˆë¡œìš´ ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì“°ê³  ìˆìŠµë‹ˆë‹¤.

  ê·¸ëƒ¥ currentHookì„ ì“°ë©´ ë˜ì§€ ì•Šì„ê¹Œìš”? ì•„ë˜ì²˜ëŸ¼ìš”

  ```javascript
  useState(initVal) {
        hooks[idx] = hooks[idx] || initialValue;
        function setState(newVal) {
          hooks[idx] = newVal;
        }
        return [hooks[idx++], setState];
  }
  ```

  setState()ê°€ í˜¸ì¶œë  ë•ŒëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ì´ ëë‚œ í›„ ì…ë‹ˆë‹¤. 

  ë”°ë¼ì„œ idxì´ ë‹¤ì‹œ 0ìœ¼ë¡œ ë¦¬ì…‹ì´ ë˜ì–´ë²„ë¦° ê²ƒì´ì£ .

  ë•Œë¬¸ì— ë³€ìˆ˜ë¥¼ í•˜ë‚˜ ë” ì„ ì–¸í•˜ê³ (_idx) ê°’ì„ ë¬¶ì–´ë†“ì•„ì•¼ í•©ë‹ˆë‹¤.

  

### Tip: í›…ì€ Top-Levelì— ì‘ì„±í•œë‹¤.

Top-Levelì— ì‘ì„±í•œë‹¤ëŠ” ê²ƒì€ í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ì˜ ë§¨ ìœ—ì¤„ì— ì‘ì„±í•˜ë¼ëŠ” ëœ»ì´ ì•„ë‹™ë‹ˆë‹¤!

ì¡°ê±´ë¬¸, ë°˜ë³µë¬¸ ë“±ì— ì¤‘ì²©ë˜ì§€ ì•Šê²Œ ì‘ì„±í•˜ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.

ë§Œì•½ ì¡°ê±´ë¬¸ì•ˆì— í›…ì„ ì‘ì„±í•˜ì—¬, í›…ì´ í˜¸ì¶œë  ë•Œê°€ ìˆê³  í˜¸ì¶œë˜ì§€ ì•Šì„ ë•Œë„ ìˆë‹¤ë©´, í›…ì´ ì°¸ì¡°í•˜ëŠ” ë°°ì—´ì˜ ì¸ë±ìŠ¤ì— í˜¼ë€ì´ ì˜¬ ìˆ˜ ë°–ì— ì—†ê² ì£ .





### ë°°ìš´ì 

í™•ì‹¤íˆ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ëœ ë°°ì› êµ¬ë‚˜..í•˜ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤.

í´ë¡œì €ë¥¼ ë¶„ëª…íˆ ë°°ì› ëŠ”ë° ë°°ìš´ ê²ƒ ê°™ì§€ ì•Šì•˜ì£  ğŸ˜“ğŸ˜¢

ë•ë¶„ì— í´ë¡œì €, ê·¸ë¦¬ê³  ëª¨ë“ˆ íŒ¨í„´ì— ëŒ€í•´ì„œ ë§ì´ ì•Œê²Œë˜ì—ˆìŠµë‹ˆë‹¤.



ìµœê·¼ì— ë©´ì ‘ì„ ë³´ë©´ì„œ, ì™œ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì˜ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ëƒ?ê³  ì§ˆë¬¸ì„ ë°›ì€ ì ì´ ìˆìŠµë‹ˆë‹¤.

ê·¸ë•Œ ì–´ë²„ë²„í•˜ë©´ì„œ ëŒ€ë‹µì„ ì˜ ëª»í–ˆëŠ”ë°, ì´ê±¸ ì˜ˆì‹œë¡œ ë“¤ì—ˆë”ë¼ë©´ ì¢‹ì•˜ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

